<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Items - Pharmacy Inventory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <style>
        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* --- 1. Dashboard Grid Layout --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            min-height: 100vh;
        }

        /* --- 2. Sidebar Styling --- */
        .sidebar {
            /* now styled globally via style.css palette; keep padding */
            padding-top: 20px;
        }

        .user-profile {
            padding: 10px 20px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
        }

        .avatar-placeholder {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #8c8c8c;
            margin-right: 10px;
        }

        .nav-links ul {
            list-style: none;
        }

        .nav-links li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: #cccccc;
            font-size: 0.95em;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav-links li a i {
            margin-right: 10px;
            width: 20px;
        }

        /* Active link styling */
        .nav-links li.active a {
            background-color: #7966a3;
            color: white;
            border-left: 5px solid #ffffff;
            padding-left: 15px;
        }

        .nav-links li:not(.active) a:hover {
            background-color: #666666;
            color: white;
        }

        /* --- 3. Main Content Area --- */
        .main-content {
            background-color: #f5f2e3; /* Beige/Cream background */
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        /* DASHBOARD CARDS STYLES (Kept for completeness) */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            z-index: 10;
            position: relative;
        }

        /* MANAGE USERS STYLES (Kept for completeness) */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-header h1 {
            font-size: 2em;
            color: #333;
            font-weight: 500;
        }


        /* --- 6. Medicine Inventory Table Styles --- */
        .medicine-header {
            font-family: "French Script MT", cursive;
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .medicine-table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
            z-index: 10; /* Above the background icon */
        }

        .medicine-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em; /* Slightly smaller font for dense data */
        }

        .medicine-table thead {
            background-color: #f5f2e3; /* Light background for the header */
        }

        .medicine-table th {
            text-align: left;
            padding: 12px 8px;
            font-weight: 600;
            color: #333;
            white-space: nowrap; /* Prevent headers from wrapping */
        }
        
        /* Column widths for the simplified medicine table */
        .medicine-table th:nth-child(1) { width: 4%; } /* Checkbox */
        .medicine-table th:nth-child(2) { width: 28%; } /* Product */
        .medicine-table th:nth-child(3) { width: 34%; } /* Description */
        .medicine-table th:nth-child(4) { width: 10%; } /* Price */
        .medicine-table th:nth-child(5) { width: 8%; } /* UoM */
        .medicine-table th:nth-child(6) { width: 8%; text-align: right;} /* Qty */
        .medicine-table th:nth-child(7) { width: 5%; text-align: right;} /* Delta */
        .medicine-table th:nth-child(8) { width: 3%; } /* Note */

        .medicine-table td {
            padding: 5px 8px;
            color: #555;
            border-bottom: 1px solid #eeeeee;
            vertical-align: top; /* Align top for multi-line cells */
        }

        .medicine-table tr:hover {
            background-color: #f9f9f9;
        }

        /* Product column styling (Brand Name/Generic Name) */
        .product-cell .brand-name {
            font-weight: bold;
            color: #333;
            font-size: 1em;
            line-height: 1.1;
        }
        .product-cell .generic-name {
            font-size: 0.85em;
            color: #777;
            line-height: 1.1;
        }

        /* Two-line data columns (Str/Form, Lot/Exp, Prgm/Loc) */
        .two-line-data .top-line {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            line-height: 1.1;
        }
        .two-line-data .bottom-line {
            font-size: 0.8em;
            color: #777;
            line-height: 1.1;
        }

        /* Highlighting for low stock (Delta = -3) */
        .low-stock-row {
            background-color: #e0f7fa; /* Light teal row highlight */
        }
        .low-stock-qty {
            font-weight: bold;
            color: #c0392b; /* Red text for low quantity */
        }
        .delta-positive {
            font-weight: bold;
            color: #27ae60; /* Green text for positive delta (stock increase) */
        }
        .delta-negative {
            font-weight: bold;
            color: #c0392b; /* Red text for negative delta (stock decrease) */
        }
        .delta-neutral {
            font-weight: bold;
            color: #7f8c8d; /* Gray text for zero delta */
        }

        .edit-icon {
            color: #3498db;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="user-profile">
                <div class="avatar-placeholder"></div>
                <div style="display:flex;flex-direction:column;">
                    <p id="userDisplay">Employee 1</p>
                    <a href="#" id="logoutLink" style="color:#ddd; font-size:0.85em; text-decoration:none; margin-top:4px;">Logout</a>
                </div>
            </div>
            <nav class="nav-links">
                <ul>
                    <li><a href="dashboard.html" class="dashboard-link"><i class="fas fa-th-large"></i> Dashboard</a></li>
                    <li><a href="manage-users.html" class="manage-users-link"><i class="fas fa-users"></i> Manage Users</a></li>
                    <li><a href="items.html" class="medicine-link"><i class="fas fa-box"></i> Items</a></li>
                    <li><a href="purchases.html"><i class="fas fa-shopping-cart"></i> Purchase</a></li>
                    <li><a href="sales.html"><i class="fas fa-tags"></i> Sale</a></li>
                    <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
        </aside>

        <div class="main-content" id="main-content-area">

            <div id="dashboard-view" style="display:none;">
                <div class="background-icon-overlay"></div>
                </div>

            <div id="users-view" style="display:none;"> 
                <div class="background-icon-overlay"></div>
                </div>

            <div id="medicine-view">
                <div class="background-icon-overlay"></div>

                <h1 class="medicine-header">Pharmacia</h1>

                <!-- Search / Filter / Controls -->
                <div style="margin-bottom:12px; display:flex; gap:10px; align-items:center;">
                    <input id="searchInput" type="search" placeholder="Search by name or category" style="flex:1; padding:8px 10px; border-radius:6px; border:1px solid #ddd;" />
                    <select title="Filter by category" id="categoryFilter" style="padding:8px 10px; border-radius:6px; border:1px solid #ddd;">
                        <option value="">All categories</option>
                    </select>
                    <button id="clearFilters" style="padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer;">Clear</button>
                </div>

                <section class="medicine-table-container">
                    <table class="medicine-table">
                        <thead>
                            <tr>
                                <th><input label="product" type="checkbox" placeholder="Select all"></th>
                                <th>Product</th>
                                <th>Description</th>
                                <th class="sortable" data-key="price">Price <i class="fas fa-sort"></i></th>
                                <th>UoM</th>
                                <th class="sortable" data-key="stock" style="text-align:right;">Qty. <i class="fas fa-sort"></i></th>
                                <th style="text-align: right;">Delta</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="medicine-tbody"></tbody>
                            <!-- Rows will be populated from data.js `items` array -->
                        </tbody>
                    </table>
                </section>
            </div>
        </div>
    </div>
    <!-- load data.js which defines `items` -->
    <script src="data.js"></script>
    <script>
        // Highlight active sidebar link based on filename
        (function(){
            const links = document.querySelectorAll('.nav-links a');
            const current = location.pathname.split('/').pop() || 'medicine.html';
            links.forEach(a => {
                const href = a.getAttribute('href');
                if (!href) return;
                if (href === current) {
                    a.closest('li').classList.add('active');
                } else {
                    a.closest('li').classList.remove('active');
                }
            });
        })();

        // Require login & Render items from data.js into the medicine table with search/filter and sorting
        document.addEventListener('DOMContentLoaded', () => {
            // basic login guard: redirect to login page if not logged in
            try {
                const name = sessionStorage.getItem('loggedInUser');
                if (!name) {
                    window.location.replace('LogIN.html');
                    return;
                }
                const el = document.getElementById('userDisplay');
                if (el) el.textContent = name;
                const logout = document.getElementById('logoutLink');
                if (logout) logout.addEventListener('click', (e) => { e.preventDefault(); try{sessionStorage.removeItem('loggedInUser')}catch{}; window.location.replace('LogIN.html'); });
            } catch (err) {
                console.warn('Login check failed', err);
            }

        
            const tbody = document.getElementById('medicine-tbody');
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const clearFilters = document.getElementById('clearFilters');
            const sortableHeaders = document.querySelectorAll('.medicine-table th.sortable');

            if (!tbody) return;

            if (typeof items === 'undefined' || !Array.isArray(items)) {
                tbody.innerHTML = '<tr><td colspan="8">No data available. Make sure <code>data.js</code> is loaded.</td></tr>';
                return;
            }

            // populate category filter options
            const categories = Array.from(new Set(items.map(i => i.category))).sort();
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                categoryFilter.appendChild(opt);
            });

            // Helper to escape HTML
            function esc(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

            // State for sorting
            let sortState = { key: null, dir: 1 }; // dir: 1 asc, -1 desc

            function applyFiltersAndRender() {
                const q = (searchInput.value || '').toLowerCase().trim();
                const cat = categoryFilter.value;

                let out = items.filter(it => {
                    if (cat && it.category !== cat) return false;
                    if (!q) return true;
                    return (it.name && it.name.toLowerCase().includes(q)) || (it.category && it.category.toLowerCase().includes(q)) || (it.description && it.description.toLowerCase().includes(q));
                });

                // Apply sort
                if (sortState.key) {
                    out.sort((a,b) => {
                        const A = a[sortState.key] ?? 0;
                        const B = b[sortState.key] ?? 0;
                        if (typeof A === 'string') return A.localeCompare(B) * sortState.dir;
                        return (A - B) * sortState.dir;
                    });
                }

                renderRows(out);
            }

            function renderRows(list) {
                tbody.innerHTML = '';
                if (!list.length) {
                    tbody.innerHTML = '<tr><td colspan="8">No items match your filters.</td></tr>';
                    return;
                }

                list.forEach(it => {
                    const lowStock = typeof it.stock === 'number' && it.stock <= 15;
                    const delta = calculateDelta(it);
                    const tr = document.createElement('tr');
                    if (lowStock) tr.classList.add('low-stock-row');

                    tr.innerHTML = `
                        <td><input type="checkbox"></td>
                        <td class="product-cell"><div class="brand-name">${esc(it.name)}</div><div class="generic-name">${esc(it.category)}</div></td>
                        <td>${esc(it.description || '')}</td>
                        <td>${it.price != null ? formatCurrency(it.price) : ''}</td>
                        <td>${esc(it.unit || '')}</td>
                        <td style="text-align: right;" class="${lowStock ? 'low-stock-qty' : ''}">${esc(it.stock)}</td>
                        <td style="text-align: right;">${formatDelta(delta)}</td>
                        <td>${it.prescriptionRequired ? '<i class="fas fa-prescription-bottle-alt" title="Prescription required"></i>' : ''} <i class="fas fa-edit edit-icon" title="Edit"></i></td>
                    `;

                    tbody.appendChild(tr);
                });
            }

            // wire search and filter
            searchInput.addEventListener('input', () => applyFiltersAndRender());
            categoryFilter.addEventListener('change', () => applyFiltersAndRender());
            clearFilters.addEventListener('click', () => { searchInput.value=''; categoryFilter.value=''; applyFiltersAndRender(); });

            // wire sortable headers
            sortableHeaders.forEach(h => {
                h.style.cursor = 'pointer';
                h.addEventListener('click', () => {
                    const key = h.getAttribute('data-key');
                    if (sortState.key === key) sortState.dir *= -1; else { sortState.key = key; sortState.dir = 1; }
                    // update sort icons (basic)
                    document.querySelectorAll('.medicine-table th.sortable i').forEach(i => i.className = 'fas fa-sort');
                    const icon = h.querySelector('i');
                    if (icon) icon.className = sortState.dir === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    applyFiltersAndRender();
                });
            });

            // initial render
            applyFiltersAndRender();
        });
    </script>
</body>
</html>